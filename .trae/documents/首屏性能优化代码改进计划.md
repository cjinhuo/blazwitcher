## 优化目标
针对最近两个 commit 中的首屏优化和分片传输逻辑，进一步提升代码质量和性能稳定性。

---

## 优化项目

### 1. 修复 RAF 数据丢失风险
**文件**: `sidepanel/hooks/useOriginalList.ts`

调整 `window_data_list` 消息处理逻辑，确保取消 RAF 后再执行 flushChunks，避免缓冲数据丢失：

```typescript
} else if (message.type === 'window_data_list') {
    if (rafId.current !== null) {
        cancelAnimationFrame(rafId.current)
        rafId.current = null
    }
    flushChunks() // 移到取消 RAF 之后
    setWindowDataList(message.data)
}
```

---

### 2. 抽取 PortMessage 类型到共享模块
**文件**: `shared/types.ts` + `sidepanel/hooks/useOriginalList.ts`

将 `PortMessage` 类型定义移到 `shared/types.ts`，供 background 和 sidepanel 共用，保持类型一致性。

---

### 3. 优化常量命名
**文件**: `shared/constants.ts`

将 `CHUNK_SIZE` 重命名为 `DATA_TRANSFER_CHUNK_SIZE`，使其语义更明确。

---

### 4. 添加分片发送延迟控制
**文件**: `background/index.ts`

为分片发送添加微任务调度，避免消息队列瞬间堆积：

```typescript
// 使用 queueMicrotask 分散消息发送
for (const chunk of chunkArray(history, DATA_TRANSFER_CHUNK_SIZE)) {
    await new Promise(resolve => queueMicrotask(resolve))
    port.postMessage({ type: 'history_chunk', data: chunk })
}
```

---

### 5. 优化 useEffect 依赖项
**文件**: `sidepanel/hooks/useOriginalList.ts`

使用 `useRef` 存储 `flushChunks` 和 `scheduleFlush` 函数引用，避免它们作为 useEffect 依赖导致不必要的重新执行。

---

## 涉及文件
| 文件 | 改动类型 |
|------|----------|
| `shared/types.ts` | 新增类型定义 |
| `shared/constants.ts` | 重命名常量 |
| `background/index.ts` | 添加微任务调度 |
| `sidepanel/hooks/useOriginalList.ts` | 修复逻辑 + 优化依赖 |

---

## 验证方式
1. 运行 `pnpm lint` 确保代码风格正确
2. 运行 `pnpm typecheck` 确保类型无误
3. 手动测试 sidepanel 打开后数据加载是否正常
