// 调试用
const currentWindowData = {
	windowId: 819044940,
	ungroupedTabs: [
		{
			itemType: 'tab',
			data: {
				id: 819044939,
				title: 'React 进阶实践指南 - 我不是外星人 - 掘金小册',
				url: 'https://juejin.cn/book/6945998773818490884/section/6948353204413268001?enter_from=search_result&utm_source=search',
				host: 'juejin.cn',
			},
		},
		{
			itemType: 'tab',
			data: {
				id: 819044941,
				title: 'mitojs',
				url: 'https://github.com/mitojs',
				host: 'github.com',
			},
		},
		{
			itemType: 'tab',
			data: {
				id: 819044942,
				title: 'fin-pre.bytedance.com/payb/front/next/verification-document/list',
				url: 'https://fin-pre.bytedance.com/payb/front/next/verification-document/list',
				host: 'fin-pre.bytedance.com',
			},
		},
		{
			itemType: 'tab',
			data: {
				id: 819044943,
				title: '对公支出-列表',
				url: 'https://fin-pre.bytedance.com/payb/front/next/payment-request/list',
				host: 'fin-pre.bytedance.com',
			},
		},
		{
			itemType: 'tab',
			data: {
				id: 819045025,
				title: '对公支出单-创建',
				url: 'https://fin-pre.bytedance.com/payb/front/next/payment-request/create?biz_key=G2025081280001067',
				host: 'fin-pre.bytedance.com',
			},
		},
		{
			itemType: 'tab',
			data: {
				id: 819045027,
				title: '供应商管理平台',
				url: 'https://procurement-pre.bytedance.net/supplier-manage/detail/fin?source=fin&takeOverToast=false&mdmCode=MDCP00484710&supId=V200347127&_preset_mode=updating&status=edit&bu=BU99&businessType=3#base',
				host: 'procurement-pre.bytedance.net',
			},
		},
		{
			itemType: 'tab',
			data: {
				id: 819044945,
				title: '团建申请',
				url: 'https://travel.bytedance.com/tb/apply',
				host: 'travel.bytedance.com',
			},
		},
		{
			itemType: 'tab',
			data: {
				id: 819044944,
				title: 'Coze Slardar JS 报错治理 - 飞书云文档',
				url: 'https://bytedance.larkoffice.com/wiki/RY0NwtvLpijiDkkc0lAcpZhenYf',
				host: 'bytedance.larkoffice.com',
			},
		},
		{
			itemType: 'tab',
			data: {
				id: 819044949,
				title: '【团建申请】 BOE/PRE小流量·流水线',
				url: 'https://bits.bytedance.net/devops/4084993794/pipeline/detail/10988504?fromBytecycle=true&devops_space_type=server_fe&enterType=url&activeTab=0&configs=%7B%7D',
				host: 'bits.bytedance.net',
			},
		},
		{
			itemType: 'tab',
			data: {
				id: 819044974,
				title: '数据探索',
				url: 'https://slardar-us.bytedance.net/node/web/data_search?env=Slardar_All&bid=ea_expense_hermes_front&lang=zh&site_type=web&region=maliva&subregion=row&start_time=1754841600&end_time=1754919258&layout=normal&ev_type=session&granularity=auto',
				host: 'slardar-us.bytedance.net',
			},
		},
		{
			itemType: 'tab',
			data: {
				id: 819045056,
				title: 'Prompt 开发',
				url: 'https://fornax.bytedance.net/space/7413735413308719106/prompt/develop/7535388483112665089',
				host: 'fornax.bytedance.net',
			},
		},
		{
			itemType: 'tab',
			data: {
				id: 819045111,
				title: 'chrome 本地大模型 - Google 搜索',
				url: 'https://www.google.com.hk/search?q=chrome+%E6%9C%AC%E5%9C%B0%E5%A4%A7%E6%A8%A1%E5%9E%8B&rlz=1C5GCEM_enCN1098CN1116&oq=chrome+%E6%9C%AC%E5%9C%B0%E5%A4%A7%E6%A8%A1%E5%9E%8B&gs_lcrp=EgZjaHJvbWUyBggAEEUYOTIKCAEQABiABBiiBDIKCAIQABiABBiiBDIKCAMQABiABBiiBNIBCDc0MTRqMGoxqAIAsAIA&sourceid=chrome&ie=UTF-8',
				host: 'www.google.com.hk',
			},
		},
		{
			itemType: 'tab',
			data: {
				id: 819045112,
				title: 'Built-in AI APIs  |  AI on Chrome  |  Chrome for Developers',
				url: 'https://developer.chrome.com/docs/ai/built-in-apis',
				host: 'developer.chrome.com',
			},
		},
	],
	existingGroups: [
		{
			id: 1002266473,
			title: '对公平台',
			color: 'green',
			memberCount: 1,
			hosts: ['bits.bytedance.net'],
			tabs: [
				{
					title: '发布·EA财务前端-火车发布空间',
					url: 'https://bits.bytedance.net/devops/4402483714/release?devops_space_type=server_fe&filters=%5B%5D&order=0&page=1&pipelineId=969949355522&releaseTab=flow&stage=965013132034&statusList=1&tab=pipeline&viewId=view-all',
					host: 'bits.bytedance.net',
					windowId: 819044940,
				},
			],
		},
		{
			id: 536467103,
			title: 'slardar监控',
			color: 'grey',
			memberCount: 2,
			hosts: ['slardar.bytedance.net'],
			tabs: [
				{
					title: '新版前端监控详情',
					url: 'https://slardar.bytedance.net/node/web_org/overview?oid=ea_expense&site_type=web&org_type=0&start_time=1720052474&end_time=1720056074&lang=zh&env=production',
					host: 'slardar.bytedance.net',
					windowId: 819044940,
				},
				{
					title: 'JS 总览',
					url: 'https://slardar.bytedance.net/node/web/js?env=prd&bid=payb&lang=zh&start_time=1753804800&end_time=1755014400&site_type=web&region=cn&subregion=undefined&layout=normal&filter_id=e1ca33299450107b1bdfd95971b8fd47&granularity=auto&time_shortcut=undefined&current_error_page=1',
					host: 'slardar.bytedance.net',
					windowId: 819044940,
				},
			],
		},
	],
	summary: {
		totalTabs: 16,
		ungroupedTabs: 13,
		existingGroupsCount: 2,
	},
}

const testSimple = async () => {
	const baseURL = 'http://localhost:3000'

	console.log('🧪 测试 ARK 流式调用...')

	try {
		const response = await fetch(`${baseURL}/ark/categorize-tabs`, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify({
				data: currentWindowData,
			}),
		})

		console.log('响应状态:', response.status)

		if (response.ok) {
			const reader = response.body.getReader()
			const decoder = new TextDecoder()
			let eventCount = 0

			console.log('开始接收SSE事件...')

			// 用于存储解析后的数据
			let statistics = null
			let addToExistingGroups = []
			let createNewGroups = []
			const processedGroups = new Set()
			let jsonBuffer = ''

			while (true) {
				const { done, value } = await reader.read()
				if (done) break

				const chunk = decoder.decode(value)
				const lines = chunk.split('\n').filter((line) => line.trim())

				for (const line of lines) {
					if (line.startsWith('data: ')) {
						const data = line.slice(6)
						eventCount++

						if (data === '[DONE]') {
							console.log(`📡 收到 [DONE] 事件，总共 ${eventCount} 个事件`)
							break
						}

						try {
							const parsed = JSON.parse(data)
							console.log('🔍 解析后的JSON:', JSON.stringify(parsed, null, 2))

							// 处理新的简化格式
							if (parsed.content !== undefined && parsed.status !== undefined) {
								console.log(`📄 收到简化格式数据: content长度=${parsed.content.length}, status=${parsed.status}`)
								
								if (parsed.content) {
									jsonBuffer += parsed.content
									console.log('📚 当前jsonBuffer长度:', jsonBuffer.length)
									console.log('📚 当前jsonBuffer内容:', jsonBuffer)

									// 每10个chunk处理一次，提高实时性
									if (eventCount % 10 === 0) {
										console.log('🔄 处理流式数据...')
										await processStreamData(jsonBuffer)
									}
								}

								// 如果状态为finished，退出循环
								if (parsed.status === 'finished') {
									console.log('📡 流式处理完成')
									break
								}
							} else if (parsed.error) {
								// 处理错误情况
								console.error('❌ 服务器返回错误:', parsed.error)
								break
							}
						} catch (e) {
							console.log('❌ 解析chunk失败:', line, e.message)
						}
					}
				}
			}

			// 最终处理
			console.log('🏁 开始最终处理，完整jsonBuffer长度:', jsonBuffer.length)
			console.log('🏁 完整jsonBuffer内容:', jsonBuffer)
			await processStreamData(jsonBuffer)

			// 处理流式数据的函数
			async function processStreamData(jsonBuffer) {
				console.log('🔧 开始处理流式数据，jsonBuffer长度:', jsonBuffer.length)
				console.log('🔧 当前jsonBuffer内容:', jsonBuffer)
				
				try {
					// 1. 解析统计信息
					if (!statistics && jsonBuffer.includes('"statistics"')) {
						const statsMatch = jsonBuffer.match(/"statistics":\s*({[^}]+})/)
						if (statsMatch) {
							try {
								const statsData = JSON.parse(statsMatch[1])
								statistics = statsData
								console.log(
									`📊 统计信息: 添加现有组 ${statsData.tabsToAddToExisting} 个, 创建新组 ${statsData.tabsToCreateNewGroups} 个`
								)
							} catch (e) { }
						}
					}

					// 2. 解析addToExistingGroups
					if (jsonBuffer.includes('"addToExistingGroups"')) {
						const existingMatch = jsonBuffer.match(/"addToExistingGroups":\s*(\[[\s\S]*?\])/)
						if (existingMatch) {
							try {
								const existingData = JSON.parse(existingMatch[1])
								if (existingData.length !== addToExistingGroups.length) {
									for (const item of existingData) {
										if (item.tabId && item.groupId) {
											const key = `existing_${item.tabId}_${item.groupId}`
											if (!processedGroups.has(key)) {
												processedGroups.add(key)
												console.log(`🚀 立即执行: 将tab ${item.tabId} 添加到组 ${item.groupId}`)
											}
										}
									}
									addToExistingGroups = existingData
								}
							} catch (e) {
								// 数据不完整，继续等待
							}
						}
					}

					// 3. 解析createNewGroups
					if (jsonBuffer.includes('"createNewGroups"')) {
						const startIndex = jsonBuffer.indexOf('"createNewGroups"')
						const afterColon = jsonBuffer.indexOf('[', startIndex)
						if (afterColon === -1) {
							return
						}

						let bracketCount = 0
						let inString = false
						let escapeNext = false
						let endIndex = -1

						for (let i = afterColon; i < jsonBuffer.length; i++) {
							const char = jsonBuffer[i]

							if (escapeNext) {
								escapeNext = false
								continue
							}

							if (char === '\\') {
								escapeNext = true
								continue
							}

							if (char === '"' && !escapeNext) {
								inString = !inString
								continue
							}

							if (!inString) {
								if (char === '[') bracketCount++
								else if (char === ']') {
									bracketCount--
									if (bracketCount === 0) {
										endIndex = i + 1
										break
									}
								}
							}
						}

						if (endIndex !== -1) {
							try {
								const newGroupsStr = jsonBuffer.substring(afterColon, endIndex)
								const newGroupsData = JSON.parse(newGroupsStr)

								if (newGroupsData.length !== createNewGroups.length) {
									console.log(`🔄 发现新的createNewGroups数据，数量: ${newGroupsData.length}`)
									for (const group of newGroupsData) {
										if (group.groupTitle && group.groupColor && group.tabIds) {
											const key = `new_${group.groupTitle}_${group.tabIds.join('_')}`
											if (!processedGroups.has(key)) {
												processedGroups.add(key)
												console.log(
													`🚀 立即执行: 创建新组 "${group.groupTitle}" (${group.groupColor}) 包含tabs ${group.tabIds.join(', ')}`
												)
											}
										}
									}
									createNewGroups = newGroupsData
								}
							} catch (e) {
								// 解析失败，继续等待更多数据
							}
						}
					}
				} catch (error) {
					// 解析错误，继续等待更多数据
				}
			}

			console.log(`✅ 流式调用成功，接收 ${eventCount} 个事件`)
		} else {
			const errorText = await response.text()
			console.log('❌ 调用失败:', errorText)
		}
	} catch (error) {
		console.error('❌ 请求失败:', error.message)
	}
}

testSimple().catch(console.error)
